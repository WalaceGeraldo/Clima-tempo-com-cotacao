<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clima & Cota√ß√£o - Portf√≥lio (Serverless)</title>
    
    <script src="https://cdn.tailwindcss.com"></script> 
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 

    <style>
        /* Estilos customizados para TEMA CLARO */
        body {
            /* Fundo claro principal */
            background-color: #f8f9fa; 
            color: #212529; /* Texto escuro */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        /* Classes de varia√ß√£o para o tema claro */
        .up-text { color: #155724; } 
        .down-text { color: #721c24; }
        .up-bg { background-color: #d4edda; } 
        .down-bg { background-color: #f8d7da; } 
        
        .weather-icon {
            width: 80px; 
            height: 80px;
        }

        /* Estilo para a barra de scroll */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #adb5bd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    
    <header class="bg-white p-8 text-center shadow-lg border-b border-gray-200">
        <h1 class="text-5xl font-extrabold text-blue-600 tracking-wider">üåç Clima & Cota√ß√£o</h1>
        <p class="text-gray-600 mt-3 text-lg font-light">Seu projeto de portf√≥lio. Dados via Netlify Functions.</p>
    </header>

    <main class="container mx-auto p-4 md:p-8">
        
        <div class="max-w-xl mx-auto mb-10">
            <div class="flex gap-3 bg-white p-3 rounded-xl shadow-xl border border-gray-200">
                <input 
                    type="text" 
                    id="city-input" 
                    placeholder="Buscar cidade (Ex: Rio de Janeiro)" 
                    class="flex-1 p-3 rounded-lg bg-gray-100 text-gray-800 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-500"
                >
                <button 
                    id="search-button" 
                    class="px-5 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                    Buscar
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div id="clima-card" class="lg:col-span-2 bg-white p-8 rounded-3xl shadow-2xl border border-gray-200 flex flex-col transition duration-300 hover:shadow-blue-300/50">
                <h2 class="text-3xl font-bold text-blue-600 pb-3 border-b border-gray-300 mb-4">‚òÅÔ∏è Detalhes do Clima</h2>
                <div id="clima-data" class="flex-grow">
                    <p class="text-gray-500">Use a busca acima ou aguarde o carregamento inicial...</p>
                </div>
            </div>

            <div id="cotacao-card" class="lg:col-span-1 bg-white p-8 rounded-3xl shadow-2xl border border-gray-200 flex flex-col transition duration-300 hover:shadow-blue-300/50">
                <h2 class="text-3xl font-bold text-blue-600 pb-3 border-b border-gray-300 mb-4">üìà Cota√ß√µes ao Vivo</h2>
                <div id="cotacao-data" class="space-y-4 flex-grow">
                    <p class="text-gray-500">Carregando dados de cota√ß√£o...</p>
                </div>
            </div>

        </div>
    </main>

    <script>
        // Vari√°vel global para gerenciar a inst√¢ncia do gr√°fico
        let tempChartInstance = null; 
        
        // --- NOVAS VARI√ÅVEIS PARA √çCONES (Simula√ß√£o) ---
        const iconImages = {};
        const iconUrls = [
            // √çcones de exemplo do OWM
            { name: 'sun', url: 'http://openweathermap.org/img/wn/01d.png' },
            { name: 'clouds', url: 'http://openweathermap.org/img/wn/04d.png' },
            { name: 'rain', url: 'http://openweathermap.org/img/wn/10d.png' }
        ];

        // Pr√©-carrega as imagens para usar como pointStyle no Chart.js
        function loadIcons() {
            iconUrls.forEach(item => {
                const img = new Image();
                img.src = item.url;
                img.width = 32;
                img.height = 32;
                iconImages[item.name] = img;
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            loadIcons(); // Carrega as imagens dos √≠cones primeiro
            fetchClima('Curitiba'); // Chamada inicial
            fetchCotacao();

            const searchButton = document.getElementById('search-button');
            const cityInput = document.getElementById('city-input');

            searchButton.addEventListener('click', () => {
                const cityName = cityInput.value.trim(); 
                if (cityName) {
                    fetchClima(cityName);
                } else {
                    alert('Por favor, digite o nome de uma cidade.');
                }
            });

            cityInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    searchButton.click();
                }
            });
        });

        // ===========================================
        // FUN√á√ÉO DE CLIMA (Com Gr√°fico e Layout Detalhado)
        // ===========================================
        async function fetchClima(city) { 
            const climaDiv = document.getElementById('clima-data');
            climaDiv.innerHTML = '<p class="text-center text-blue-600">Buscando dados para ' + city + '...</p>';

            if (tempChartInstance) {
                tempChartInstance.destroy();
            }

            const url = `/.netlify/functions/getClima?city=${encodeURIComponent(city)}`; 

            try {
                const response = await fetch(url);
                
                if (!response.ok) {
                    climaDiv.innerHTML = `<p class="text-red-700">Erro de rede (${response.status}) ao buscar a fun√ß√£o.</p>`;
                    return;
                }
                
                const data = await response.json();

                if (data.error) {
                    climaDiv.innerHTML = `<p class="text-red-700 font-semibold mt-4">
                        üö® Erro de API para ${city}: ${data.error}<br>
                        Verifique o nome da cidade ou a chave do OpenWeatherMap.
                    </p>`;
                    return;
                }

                // 1. ESTRUTURA HTML DETALHADA
                climaDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h3 class="text-4xl font-bold text-gray-900">${data.cidade}, ${data.pais}</h3>
                            <p class="text-lg text-gray-600 mt-1">${data.descricao.charAt(0).toUpperCase() + data.descricao.slice(1)}</p>
                            <p class="text-6xl font-extrabold text-blue-600 mt-2">${Math.round(data.temperatura)}¬∞C</p>
                        </div>
                        <div>
                            <img src="http://openweathermap.org/img/wn/${data.icone}@4x.png" alt="√çcone do Clima" class="weather-icon mx-auto">
                        </div>
                    </div>

                    <h4 class="text-xl font-semibold text-gray-700 pb-2 border-b border-gray-300 mb-4">Previs√£o de 5 Horas (Simulado)</h4>
                    <div class="h-40 mb-6 bg-gray-100 p-2 rounded-lg border border-gray-300"> 
                        <canvas id="temperatura-chart"></canvas>
                    </div>
                    
                    <h4 class="text-xl font-semibold text-gray-700 pb-2 border-b border-gray-300 mb-4 mt-6">Detalhes do Dia</h4>
                    <div id="clima-detalhes" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-gray-100 p-3 rounded-lg hover:bg-gray-200 transition duration-150"><p class="text-gray-500 text-sm">M√≠nima</p><p class="text-lg font-semibold">${Math.round(data.temperaturaMin)}¬∞C</p></div>
                        <div class="bg-gray-100 p-3 rounded-lg hover:bg-gray-200 transition duration-150"><p class="text-gray-500 text-sm">M√°xima</p><p class="text-lg font-semibold">${Math.round(data.temperaturaMax)}¬∞C</p></div>
                        <div class="bg-gray-100 p-3 rounded-lg hover:bg-gray-200 transition duration-150"><p class="text-gray-500 text-sm">Umidade</p><p class="text-lg font-semibold">75%</p></div> 
                        <div class="bg-gray-100 p-3 rounded-lg hover:bg-gray-200 transition duration-150"><p class="text-gray-500 text-sm">Vento</p><p class="text-lg font-semibold">12 km/h</p></div> 
                    </div>
                `;
                
                // 2. CRIA√á√ÉO DO GR√ÅFICO (Dados Simulados com √çcones)
                const ctx = document.getElementById('temperatura-chart').getContext('2d');
                tempChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Agora', '1h', '2h', '3h', '4h'], 
                        datasets: [{
                            label: 'Temperatura (¬∞C)',
                            data: [data.temperatura, data.temperatura + 2, data.temperatura - 1, data.temperatura + 3, data.temperatura], 
                            borderColor: '#3b82f6', 
                            backgroundColor: 'rgba(59, 130, 246, 0.2)', 
                            fill: true,
                            tension: 0.3,
                            pointBackgroundColor: '#fff',
                            // === CONFIGURA√á√ÉO AVAN√áADA DE √çCONES ===
                            pointStyle: [
                                iconImages.sun,        
                                iconImages.clouds,     
                                iconImages.rain,       
                                iconImages.sun,        
                                iconImages.clouds      
                            ], 
                            pointRadius: 16, 
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, 
                        scales: {
                            x: { ticks: { color: '#6b7280' }, grid: { display: false } },
                            y: { display: false, grid: { display: false } },
                        },
                        plugins: {
                            legend: { display: false },
                            title: { display: false }
                        }
                    }
                });

            } catch (error) {
                climaDiv.innerHTML = `<p class="text-red-700">Falha na comunica√ß√£o total com o servidor.</p>`;
                console.error('Erro ao buscar clima:', error);
            }
        }

        // ===========================================
        // FUN√á√ÉO DE COTA√á√ÉO (Final)
        // ===========================================
        async function fetchCotacao() {
            const cotacaoDiv = document.getElementById('cotacao-data');
            const url = '/.netlify/functions/getCotacao';

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    cotacaoDiv.innerHTML = `<p class="text-red-700">Erro de rede (${response.status}) ao buscar a fun√ß√£o.</p>`;
                    return;
                }

                const cotacoes = await response.json();

                if (cotacoes.error) {
                    cotacaoDiv.innerHTML = `<p class="text-red-700">Erro ao buscar cota√ß√µes: ${cotacoes.error}</p>`;
                    return;
                }

                let html = '';
                for (const key in cotacoes) {
                    const item = cotacoes[key];
                    if (!item || item.valor === undefined) continue;
                    
                    const nome = key.toUpperCase();
                    
                    const variacaoClass = item.variacao > 0 ? 'up-text up-bg' : (item.variacao < 0 ? 'down-text down-bg' : 'text-gray-600');
                    const simbolo = item.variacao > 0 ? '‚ñ≤' : (item.variacao < 0 ? '‚ñº' : '‚Äî');
                    
                    html += `
                        <div class="flex justify-between items-center pb-3 border-b border-gray-300 last:border-b-0">
                            <span class="text-gray-700 font-medium">${nome} (BRL)</span>
                            <span class="flex items-center gap-2 font-bold text-gray-900">
                                R$ ${item.valor}
                                <span class="text-sm font-semibold ${variacaoClass} p-1 rounded">
                                    ${simbolo} ${item.variacao}%
                                </span>
                            </span>
                        </div>
                    `;
                }

                cotacaoDiv.innerHTML = html;

            } catch (error) {
                cotacaoDiv.innerHTML = `<p class="text-red-700">Falha na conex√£o com o servidor de cota√ß√£o.</p>`;
                console.error('Erro ao buscar cota√ß√£o:', error);
            }
        }
    </script>
</body>
</html>